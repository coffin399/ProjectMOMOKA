name: Build and Release Executables

on:
  workflow_dispatch:
    inputs:
      version:
        description: "New version tag (e.g., v1.2.3 or 1.2.3)"
        required: true
        type: string
      prerelease:
        description: "Mark as prerelease"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  NUITKA_VERSION: '1.9.7'
  PYTHON_VERSION: '3.11'

jobs:
  build-all:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            ext: ''
          - os: windows-latest
            platform: win
            ext: '.exe'
          - os: macos-latest
            platform: mac
            ext: ''
      fail-fast: false

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Nuitka
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuitka
            ~/.cache/Nuitka
          key: nuitka-${{ runner.os }}-${{ env.NUITKA_VERSION }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            nuitka-${{ runner.os }}-${{ env.NUITKA_VERSION }}-
            nuitka-${{ runner.os }}-

      - name: Install Nuitka
        run: pip install nuitka==${{ env.NUITKA_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build executable (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          python -m nuitka \
            --onefile \
            --output-dir=dist \
            --output-filename=MOMOKA${{ matrix.ext }} \
            --include-data-file=config.default.yaml=config.default.yaml \
            --include-package=MOMOKA \
            --include-package-data=MOMOKA \
            --include-package-data=MOMOKA.images \
            --include-package-data=MOMOKA.images.error \
            --include-package-data=MOMOKA.llm \
            --include-package-data=MOMOKA.llm.error \
            --include-package-data=MOMOKA.llm.plugins \
            --include-package-data=MOMOKA.llm.utils \
            --include-package-data=MOMOKA.media_downloader \
            --include-package-data=MOMOKA.media_downloader.error \
            --include-package-data=MOMOKA.music \
            --include-package-data=MOMOKA.music.error \
            --include-package-data=MOMOKA.music.plugins \
            --include-package-data=MOMOKA.notifications \
            --include-package-data=MOMOKA.notifications.error \
            --include-package-data=MOMOKA.services \
            --include-package-data=MOMOKA.timer \
            --include-package-data=MOMOKA.timer.error \
            --include-package-data=MOMOKA.tracker \
            --include-package-data=MOMOKA.tracker.error \
            --include-package-data=MOMOKA.tts \
            --include-package-data=MOMOKA.tts.error \
            --include-package-data=MOMOKA.utilities \
            --include-package-data=MOMOKA.utilities.error \
            --include-package-data=discord \
            --include-package-data=yaml \
            --include-package-data=openai \
            --include-package-data=google \
            --include-package-data=PIL \
            --include-package-data=matplotlib \
            --include-package-data=cartopy \
            --include-package-data=langdetect \
            --include-package-data=aiohttp \
            --include-package-data=aiofiles \
            --include-package-data=nacl \
            --include-package-data=yt_dlp \
            --assume-yes-for-downloads \
            --show-progress \
            --show-memory \
            --jobs=4 \
            main.py

      - name: Build executable (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          python -m nuitka `
            --onefile `
            --output-dir=dist `
            --output-filename=MOMOKA${{ matrix.ext }} `
            --include-data-file=config.default.yaml=config.default.yaml `
            --include-package=MOMOKA `
            --include-package-data=MOMOKA `
            --include-package-data=MOMOKA.images `
            --include-package-data=MOMOKA.images.error `
            --include-package-data=MOMOKA.llm `
            --include-package-data=MOMOKA.llm.error `
            --include-package-data=MOMOKA.llm.plugins `
            --include-package-data=MOMOKA.llm.utils `
            --include-package-data=MOMOKA.media_downloader `
            --include-package-data=MOMOKA.media_downloader.error `
            --include-package-data=MOMOKA.music `
            --include-package-data=MOMOKA.music.error `
            --include-package-data=MOMOKA.music.plugins `
            --include-package-data=MOMOKA.notifications `
            --include-package-data=MOMOKA.notifications.error `
            --include-package-data=MOMOKA.services `
            --include-package-data=MOMOKA.timer `
            --include-package-data=MOMOKA.timer.error `
            --include-package-data=MOMOKA.tracker `
            --include-package-data=MOMOKA.tracker.error `
            --include-package-data=MOMOKA.tts `
            --include-package-data=MOMOKA.tts.error `
            --include-package-data=MOMOKA.utilities `
            --include-package-data=MOMOKA.utilities.error `
            --include-package-data=discord `
            --include-package-data=yaml `
            --include-package-data=openai `
            --include-package-data=google `
            --include-package-data=PIL `
            --include-package-data=matplotlib `
            --include-package-data=cartopy `
            --include-package-data=langdetect `
            --include-package-data=aiohttp `
            --include-package-data=aiofiles `
            --include-package-data=nacl `
            --include-package-data=yt_dlp `
            --assume-yes-for-downloads `
            --show-progress `
            --show-memory `
            --jobs=4 `
            main.py

      - name: Verify build output and set permissions (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          if [ ! -f "dist/MOMOKA${{ matrix.ext }}" ]; then
            echo "Build failed: MOMOKA${{ matrix.ext }} not found in dist/"
            ls -la dist/ || ls -la
            exit 1
          fi
          echo "Build successful: MOMOKA${{ matrix.ext }} found"
          chmod +x "dist/MOMOKA${{ matrix.ext }}"
          ls -lh "dist/MOMOKA${{ matrix.ext }}"

      - name: Verify build output (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (-not (Test-Path "dist/MOMOKA${{ matrix.ext }}")) {
            Write-Error "Build failed: MOMOKA${{ matrix.ext }} not found in dist/"
            Get-ChildItem dist/ -ErrorAction SilentlyContinue
            Get-ChildItem .
            exit 1
          }
          Write-Host "Build successful: MOMOKA${{ matrix.ext }} found"
          Get-ChildItem "dist/MOMOKA${{ matrix.ext }}" | Format-List

      - name: Copy build files (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "release_package" -Force
          Copy-Item "dist/MOMOKA${{ matrix.ext }}" "release_package/"
          Copy-Item "config.default.yaml" "release_package/"
          Copy-Item "requirements.txt" "release_package/"

          $readmeContent = @"
          MOMOKA Release Package
          =====================

          Files included:
          - MOMOKA${{ matrix.ext }}: Main executable
          - config.default.yaml: Default configuration (will be copied to config.yaml on first run)
          - requirements.txt: Python dependencies (for reference only)

          Required files (user must provide):
          - client_secrets.json: Google API credentials (for image generation and TTS features)

          Auto-generated at runtime:
          - config.yaml: Application configuration (generated from config.default.yaml on first run)
          - data/: Directory containing various JSON data files generated during execution

          Usage:
          1. Copy client_secrets.json to this directory
          2. Run MOMOKA${{ matrix.ext }}
          3. The first run will generate config.yaml from config.default.yaml
          4. Edit config.yaml with your bot token and API keys
          5. Run MOMOKA${{ matrix.ext }} again

          Platform: ${{ matrix.os }} (${{ matrix.platform }})
          Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          "@

          $readmeContent | Out-File -FilePath "release_package/README.txt" -Encoding UTF8

      - name: Copy build files (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          mkdir -p release_package
          cp "dist/MOMOKA${{ matrix.ext }}" release_package/
          cp config.default.yaml release_package/
          cp requirements.txt release_package/

          cat > release_package/README.txt << 'EOF'
          MOMOKA Release Package
          =====================

          Files included:
          - MOMOKA: Main executable
          - config.default.yaml: Default configuration (will be copied to config.yaml on first run)
          - requirements.txt: Python dependencies (for reference only)

          Required files (user must provide):
          - client_secrets.json: Google API credentials (for image generation and TTS features)

          Auto-generated at runtime:
          - config.yaml: Application configuration (generated from config.default.yaml on first run)
          - data/: Directory containing various JSON data files generated during execution

          Usage:
          1. Copy client_secrets.json to this directory
          2. Run ./MOMOKA
          3. The first run will generate config.yaml from config.default.yaml
          4. Edit config.yaml with your bot token and API keys
          5. Run ./MOMOKA again
          EOF

          echo "" >> release_package/README.txt
          echo "Platform: ${{ matrix.os }} (${{ matrix.platform }})" >> release_package/README.txt
          echo "Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> release_package/README.txt

      - name: Create zip package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path "release_package/*" -DestinationPath "MOMOKA-${{ matrix.platform }}.zip" -Force
          if (-not (Test-Path "MOMOKA-${{ matrix.platform }}.zip")) {
            Write-Error "Failed to create zip package"
            exit 1
          }
          $fileSize = (Get-Item "MOMOKA-${{ matrix.platform }}.zip").Length / 1MB
          Write-Host "Zip package created successfully (Size: $([math]::Round($fileSize, 2)) MB)"

      - name: Create zip package (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cd release_package
          zip -r "../MOMOKA-${{ matrix.platform }}.zip" .
          cd ..
          if [ ! -f "MOMOKA-${{ matrix.platform }}.zip" ]; then
            echo "Failed to create zip package"
            exit 1
          fi
          size=$(du -h "MOMOKA-${{ matrix.platform }}.zip" | cut -f1)
          echo "Zip package created successfully (Size: $size)"

      - name: Archive release package
        uses: actions/upload-artifact@v4
        with:
          name: momoka-release-${{ matrix.platform }}
          path: MOMOKA-${{ matrix.platform }}.zip
          retention-days: 90

  create-release:
    needs: build-all
    runs-on: ubuntu-latest
    if: needs.build-all.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Get version
        id: get_version
        run: |
          VERSION=$(date +'%Y%m%d-%H%M%S')
          SHA=$(git rev-parse --short HEAD)
          FULL_VERSION="${VERSION}-${SHA}"
          echo "VERSION=$FULL_VERSION" >> $GITHUB_ENV
          echo "VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "Version: $FULL_VERSION"

      - name: Prepare release files
        run: |
          mkdir -p release_assets

          for platform in linux win mac; do
            artifact_path="artifacts/momoka-release-${platform}/MOMOKA-${platform}.zip"
            if [ -f "$artifact_path" ]; then
              cp "$artifact_path" release_assets/
              size=$(du -h "$artifact_path" | cut -f1)
              echo "Found: MOMOKA-${platform}.zip (Size: $size)"
            else
              echo "Missing release file: $artifact_path"
              exit 1
            fi
          done

          echo "Release assets:"
          ls -lh release_assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body: |
            ## Auto-generated Release ${{ env.VERSION }}

            This is an automated release build from the `advanced-bot-utilities` branch.

            ### Downloads
            - **MOMOKA-linux.zip**: Linux executable package
            - **MOMOKA-win.zip**: Windows executable package
            - **MOMOKA-mac.zip**: macOS executable package

            ### Package Contents
            Each zip file contains:
            - `MOMOKA` (or `MOMOKA.exe` on Windows): Main executable
            - `config.default.yaml`: Default configuration
            - `requirements.txt`: Python dependencies reference
            - `README.txt`: Detailed setup instructions

            ### First-time Setup
            1. Download the zip file for your platform
            2. Extract the zip file
            3. Copy your `client_secrets.json` file to the extracted directory
            4. Run the executable (see platform-specific notes below)
            5. Edit the generated `config.yaml` file with your credentials
            6. Run the executable again

            ### Platform-specific Notes

            #### macOS
            - You may need to right-click and select "Open" the first time due to Gatekeeper
            - Or run: `xattr -d com.apple.quarantine MOMOKA` in Terminal

            #### Linux
            - Ensure executable permissions: `chmod +x MOMOKA`
            - Run with: `./MOMOKA`

            #### Windows
            - Windows Defender may show a warning for unsigned executables
            - Click "More info" and then "Run anyway" if prompted

            ### Dependencies
            Built with:
            - Python ${{ env.PYTHON_VERSION }}
            - Nuitka ${{ env.NUITKA_VERSION }}

            ---

            **Commit**: ${{ github.sha }}
            **Branch**: ${{ github.ref_name }}
          files: release_assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}